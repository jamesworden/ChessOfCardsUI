<div class="game-container">
  <div
    class="game"
    *ngIf="playerGameState$ | async as playerGameState"
    cdkDropListGroup
  >
    <div
      class="opponent-hand"
      [ngStyle]="{
        height: (responsiveSizeService.cardSize$ | async) + 'px',
        padding:
          '0px ' + ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px',
        'margin-top':
          '-' + ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px'
      }"
    >
      <app-face-down-card
        *ngFor="
          let _ of [].constructor(playerGameState.NumCardsInOpponentsHand)
        "
      ></app-face-down-card>
    </div>

    <!-- Host Board View -->

    <div
      class="board"
      *ngIf="playerGameState.IsHost"
      [ngStyle]="{
        padding:
          ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px 0px'
      }"
    >
      <div
        class="gutter"
        [ngStyle]="{
          width: ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px'
        }"
      ></div>

      <ng-container
        *ngFor="let lane of playerGameState.Lanes; let laneIndex = index"
      >
        <ng-container
          *ngIf="
            (initialPlaceMultipleCardAttempt$ | async)?.TargetLaneIndex !=
            laneIndex
          "
        >
          <div
            class="lane"
            [ngStyle]="{
              'background-color':
                getLaneBackgroundColor(laneIndex) ?? 'transparent'
            }"
          >
            <ng-container *ngFor="let row of lane.Rows; let rowIndex = index">
              <app-position
                [laneIndex]="laneIndex"
                [rowIndex]="6 - rowIndex"
                (placeCardAttempted)="onPlaceCardAttempted($event)"
              >
                <app-card
                  *ngIf="lane.Rows[6 - rowIndex].length > 0"
                  [card]="getTopCard(lane.Rows[6 - rowIndex])"
                  [cardImageFileName]="
                    getCardImageFileName(getTopCard(lane.Rows[6 - rowIndex]))
                  "
                  [backgroundColor]="
                    getCardBackgroundColor(
                      getTopCard(lane.Rows[6 - rowIndex]),
                      laneIndex
                    )
                  "
                  [isMiddleCard]="rowIndex === 3"
                  [isPlayedBy]="getTopCard(lane.Rows[6 - rowIndex]).PlayedBy"
                  [isHost]="true"
                ></app-card>

                <app-card
                  *ngIf="
                    lane.Rows[6 - rowIndex].length <= 0 &&
                    lane.WonBy != PlayerOrNone.None &&
                    rowIndex === 3
                  "
                  [cardImageFileName]="
                    getJokerImageFileName(
                      laneIndex,
                      playerGameState.RedJokerLaneIndex,
                      playerGameState.BlackJokerLaneIndex
                    )
                  "
                  [isMiddleCard]="rowIndex === 3"
                  [isPlayedBy]="lane.WonBy"
                  [isHost]="false"
                ></app-card>
              </app-position>
            </ng-container>
          </div>
        </ng-container>

        <app-place-multiple-cards-lane
          *ngIf="
            (initialPlaceMultipleCardAttempt$ | async)?.TargetLaneIndex ===
            laneIndex
          "
        ></app-place-multiple-cards-lane>
      </ng-container>

      <div
        class="gutter"
        [ngStyle]="{
          width: ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px'
        }"
      >
        <app-deck
          [totalNumCards]="playerGameState.NumCardsInOpponentsDeck"
          [rightSide]="true"
        ></app-deck>

        <app-deck
          [totalNumCards]="playerGameState.NumCardsInPlayersDeck"
          [rightSide]="true"
        ></app-deck>
      </div>
    </div>

    <!-- Guest Board View -->

    <div
      class="board"
      *ngIf="!playerGameState.IsHost"
      [ngStyle]="{
        padding:
          ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px 0px'
      }"
    >
      <div
        class="gutter"
        [ngStyle]="{
          width: ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px'
        }"
      >
        <app-deck
          [totalNumCards]="playerGameState.NumCardsInOpponentsDeck"
          [rightSide]="false"
        ></app-deck>

        <app-deck
          [totalNumCards]="playerGameState.NumCardsInPlayersDeck"
          [rightSide]="false"
        ></app-deck>
      </div>

      <ng-container
        *ngFor="let lane of playerGameState.Lanes; let laneIndex = index"
      >
        <ng-container
          *ngIf="
            (initialPlaceMultipleCardAttempt$ | async)?.TargetLaneIndex !=
            4 - laneIndex
          "
        >
          <div
            class="lane"
            [ngStyle]="{
              'background-color':
                getLaneBackgroundColor(4 - laneIndex) ?? 'transparent'
            }"
          >
            <ng-container
              *ngFor="
                let row of playerGameState.Lanes[4 - laneIndex].Rows;
                let rowIndex = index
              "
            >
              <app-position
                [laneIndex]="4 - laneIndex"
                [rowIndex]="rowIndex"
                (placeCardAttempted)="onPlaceCardAttempted($event)"
              >
                <app-card
                  *ngIf="row.length > 0"
                  [backgroundColor]="
                    getCardBackgroundColor(getTopCard(row), 4 - laneIndex)
                  "
                  [card]="getTopCard(row)"
                  [cardImageFileName]="getCardImageFileName(getTopCard(row))"
                  [isMiddleCard]="rowIndex === 3"
                  [isPlayedBy]="getTopCard(row).PlayedBy"
                  [isHost]="false"
                ></app-card>

                <app-card
                  *ngIf="
                    row.length <= 0 &&
                    playerGameState.Lanes[4 - laneIndex].WonBy !=
                      PlayerOrNone.None &&
                    rowIndex === 3
                  "
                  [cardImageFileName]="
                    getJokerImageFileName(
                      4 - laneIndex,
                      playerGameState.RedJokerLaneIndex,
                      playerGameState.BlackJokerLaneIndex
                    )
                  "
                  [isMiddleCard]="rowIndex === 3"
                  [isPlayedBy]="playerGameState.Lanes[4 - laneIndex].WonBy"
                  [isHost]="false"
                ></app-card>
              </app-position>
            </ng-container>
          </div>
        </ng-container>

        <app-place-multiple-cards-lane
          *ngIf="
            (initialPlaceMultipleCardAttempt$ | async)?.TargetLaneIndex ===
            4 - laneIndex
          "
        ></app-place-multiple-cards-lane>
      </ng-container>

      <div
        class="gutter"
        [ngStyle]="{
          width: ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px'
        }"
      ></div>
    </div>

    <!-- End Board Views -->

    <div class="player-hand-container">
      <div
        class="player-hand"
        id="player-hand"
        cdkDropList
        [cdkDropListConnectedTo]="
          isPlacingMultipleCards ? 'place-multiple-cards-list' : 'position'
        "
        (cdkDropListDropped)="onPlayerHandCardDrop($event)"
        cdkDropListData="player-hand"
        cdkDropListOrientation="horizontal"
        *ngIf="playerGameState.Hand"
        [ngStyle]="{
          height: (responsiveSizeService.cardSize$ | async) + 'px',
          margin: 'auto'
        }"
      >
        <app-card
          *ngFor="
            let card of isPlacingMultipleCards
              ? (placeMultipleCardsHand$ | async) ?? []
              : playerGameState.Hand.Cards
          "
          [cardImageFileName]="getCardImageFileName(card)"
          [card]="card"
          [playerCanDrag]="true"
        ></app-card>
      </div>
    </div>

    <div
      class="button-toolbar"
      [ngStyle]="{
        padding:
          '0px ' + ((responsiveSizeService.cardSize$ | async) ?? 64) / 2 + 'px'
      }"
    >
      <ng-container *ngIf="isPlacingMultipleCards">
        <button
          mat-raised-button
          class="confirm-button"
          color="primary"
          (click)="onConfirmButtonClicked()"
        >
          Confirm
        </button>
        <div class="button-divider"></div>
        <button
          mat-raised-button
          class="cancel-button"
          color="warn"
          (click)="onCancelButtonClicked()"
        >
          Cancel
        </button>
      </ng-container>

      <ng-container *ngIf="!isPlacingMultipleCards">
        <button
          (click)="onPassButtonClicked()"
          mat-raised-button
          color="primary"
          class="pass-button"
          [disabled]="!isPlayersTurn"
        >
          Pass
        </button>
      </ng-container>
    </div>
  </div>
</div>
