<app-sidebar class="h-full" [isPlayersTurn]="isPlayersTurn"></app-sidebar>

<app-animation-overlay
  [animatedEntities]="(animatedCardEntities$ | async) ?? []"
  (finishedAnimations)="renderAnimatedGameView()"
  (startingAnimations)="checkToRemoveCardFromBoard($event)"
></app-animation-overlay>

<div class="flex justify-around w-full bg-gray-800">
  <div
    class="game flex flex-col justify-between h-full"
    *ngIf="playerGameView$ | async as playerGameView"
    cdkDropListGroup
  >
    <app-player-banner
      [username]="playerGameView.IsHost ? 'Guest Player' : 'Host Player'"
      class="rounded-b-md bg-rose-900"
    ></app-player-banner>

    <ng-container [ngTemplateOutlet]="opponentHandToolbar"></ng-container>

    <app-board
      *ngIf="latestGameViewSnapshot$ | async as latestGameViewSnapshot"
      [playerGameView]="latestGameViewSnapshot"
      [isPlacingMultipleCards]="isPlacingMultipleCards$ | async"
      [initialPlaceMultipleCardAttempt]="
        initialPlaceMultipleCardAttempt$ | async
      "
      (placeCardAttempted)="onPlaceCardAttempted($event)"
    ></app-board>

    <app-player-hand
      [isPlacingMultipleCards]="isPlacingMultipleCards"
      [isHost]="playerGameView.IsHost"
      [cards]="playerGameView.Hand.Cards"
      [cardSize]="(cardSize$ | async)!"
      [disabled]="!isPlayersTurn || !!(waitingForServer$ | async)"
      (cardDropped)="onPlayerHandCardDrop($event)"
    ></app-player-hand>

    <app-player-banner
      [username]="playerGameView.IsHost ? 'Host Player' : 'Guest Player'"
      class="rounded-t-md bg-sky-900"
    ></app-player-banner>
  </div>
</div>

<ng-template #opponentHandToolbar>
  <ng-container
    *ngIf="
      !(isPlacingMultipleCards$ | async) &&
      !(hasPendingDrawOffer$ | async) &&
      !(possibleInitialPlaceCardAttempts.length === 0 && isPlayersTurn)
    "
  >
    <app-opponent-hand
      [cardSize]="(cardSize$ | async)!"
      [numCards]="(latestGameViewSnapshot$ | async)!.NumCardsInOpponentsHand"
    ></app-opponent-hand>
  </ng-container>

  <ng-container *ngIf="isPlacingMultipleCards$ | async">
    <div class="buttons-container">
      <div
        class="button-question text-gray-800"
        [ngStyle]="{
          'min-width': (cardSize$ | async)! + 'px'
        }"
      >
        <span>Place<br />Cards?</span>
      </div>

      <div style="display: flex">
        <app-sidebar-item
          [itemHeight]="(cardSize$ | async)!"
          [itemWidth]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Confirm"
          matTooltipPosition="below"
          materialSymbol="check"
          (selected)="onConfirmButtonClicked()"
        ></app-sidebar-item>
        <app-sidebar-item
          [itemHeight]="(cardSize$ | async)!"
          [itemWidth]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Cancel"
          matTooltipPosition="below"
          materialSymbol="close"
          (selected)="onCancelButtonClicked()"
        ></app-sidebar-item>
      </div>
    </div>
  </ng-container>

  <ng-container
    *ngIf="!(isPlacingMultipleCards$ | async) && (hasPendingDrawOffer$ | async)"
  >
    <div class="buttons-container">
      <div
        class="button-question text-gray-800"
        [ngStyle]="{
          'min-width': (cardSize$ | async)! + 'px'
        }"
      >
        <span>Accept<br />Draw?</span>
      </div>

      <div style="display: flex">
        <app-sidebar-item
          [itemWidth]="(cardSize$ | async)!"
          [itemHeight]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Accept draw"
          matTooltipPosition="below"
          materialSymbol="check"
          (selected)="acceptDraw()"
        ></app-sidebar-item>
        <app-sidebar-item
          [itemHeight]="(cardSize$ | async)!"
          [itemWidth]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Deny draw"
          matTooltipPosition="below"
          materialSymbol="close"
          (selected)="denyDraw()"
        ></app-sidebar-item>
      </div>
    </div>
  </ng-container>

  <ng-container
    *ngIf="
      possibleInitialPlaceCardAttempts.length === 0 &&
      isPlayersTurn &&
      !(isPlacingMultipleCards$ | async) &&
      !(hasPendingDrawOffer$ | async)
    "
  >
    <div class="buttons-container">
      <div
        class="button-question text-gray-800"
        [ngStyle]="{
          'min-width': (cardSize$ | async)! + 'px'
        }"
      >
        <span>You have no available moves.<br />Would you like to pass?</span>
      </div>

      <div style="display: flex">
        <app-sidebar-item
          [itemWidth]="(cardSize$ | async)!"
          [itemHeight]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Pass"
          matTooltipPosition="below"
          materialSymbol="check"
          (selected)="passMove()"
        ></app-sidebar-item>
      </div>
    </div>
  </ng-container>
</ng-template>

<ng-template #cardMovementTemplate let-animatedEntity>
  @if (animatedEntity.context.Card) {
  <ng-container
    *ngIf="playerGameViewToAnimate$ | async as playerGameViewToAnimate"
  >
    <app-card
      [card]="animatedEntity.context.Card"
      [@cardRotation]="{
        value:
          (animatedEntity.styles?.before.rotate ?? 0) ===
          (animatedEntity.styles?.after.rotate ?? 0)
            ? 'not-rotating'
            : 'rotating',
        params: {
          fromRotate: animatedEntity.styles?.before.rotate ?? '0deg',
          toRotate: animatedEntity.styles?.after.rotate ?? '0deg',
          durationMs: animatedEntity.movement.durationMs
        }
      }"
    ></app-card>
  </ng-container>
  } @else {
  <app-face-down-card></app-face-down-card>
  }
</ng-template>
