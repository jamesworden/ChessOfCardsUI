<div
  class="fixed top-0 left-0 min-h-[calc(100dvh)] max-h-[calc(100dvh)] flex justify-between w-full"
  [@fadeInOut]
>
  <app-sidebar [isPlayersTurn]="isPlayersTurn"></app-sidebar>

  <animation-overlay
    [animatedEntities]="(animatedCardEntities$ | async) ?? []"
    (finishedAnimations)="renderAnimatedGameView()"
    (startingAnimations)="checkToRemoveCardFromBoard($event)"
  ></animation-overlay>

  <div
    class="flex justify-around w-full dark:bg-gray-800 bg-gray-300 transition"
  >
    @if (playerGameView$ | async; as playerGameView) {
      <div class="game flex flex-col justify-between h-full" cdkDropListGroup>
        <app-player-banner
          [username]="playerGameView.IsHost ? 'Guest Player' : 'Host Player'"
          class="rounded-b-md transition"
          [ngClass]="{
            'bg-rose-700': !isPlayersTurn,
            'bg-rose-900': isPlayersTurn
          }"
        ></app-player-banner>

        <ng-container [ngTemplateOutlet]="opponentHandToolbar"></ng-container>

        @if (latestGameViewSnapshot$ | async; as latestGameViewSnapshot) {
          <game-board
            #board
            [playerGameView]="latestGameViewSnapshot"
            [isPlacingMultipleCards]="isPlacingMultipleCards$ | async"
            [initialPlaceMultipleCardAttempt]="
              initialPlaceMultipleCardAttempt$ | async
            "
            [isPlayersTurn]="isPlayersTurn"
            [placeMultipleCards]="placeMultipleCards$ | async"
            [placeMultipleCardsHand]="placeMultipleCardsHand$ | async"
            [selectedCard]="selectedCard$ | async"
            (placeCardAttempted)="onPlaceCardAttempted($event)"
            (setPlaceMultipleCards)="placedMultipleCards($event)"
            (setPlaceMultipleCardsHand)="placedMultipleCardsHand($event)"
            (positionClicked)="onPositionClicked($event)"
            (placeMultipleCardsListClicked)="
              moveSelectedCardToPlaceMultipleList()
            "
          ></game-board>
        }

        <game-player-hand
          #playerHand
          [isPlacingMultipleCards]="isPlacingMultipleCards"
          [isHost]="playerGameView.IsHost"
          [cards]="playerGameView.Hand.Cards"
          [cardSize]="(cardSize$ | async)!"
          [disabled]="!!(waitingForServer$ | async)"
          [isPlayersTurn]="isPlayersTurn"
          [placeMultipleCardsHand]="placeMultipleCardsHand$ | async"
          [isGameActive]="(gameIsActive$ | async) ?? false"
          [initialPlaceMultipleCardsAttempt]="
            initialPlaceMultipleCardAttempt$ | async
          "
          [selectedCard]="selectedCard$ | async"
          (cardDropped)="onPlayerHandCardDrop($event)"
          (cardDragStarted)="onCardDragStarted($event)"
          (cardDragEnded)="onCardDragEnded()"
          (cardClicked)="onCardClicked($event)"
        ></game-player-hand>

        <app-player-banner
          [username]="playerGameView.IsHost ? 'Host Player' : 'Guest Player'"
          class="rounded-t-md transition"
          [ngClass]="{
            'bg-sky-700': isPlayersTurn,
            'bg-sky-900': !isPlayersTurn
          }"
        ></app-player-banner>
      </div>
    }
  </div>

  <div>
    <!-- Empty div on mobile, stats panel on desktop. -->
  </div>
</div>

<ng-template #opponentHandToolbar>
  @if (
    !(isPlacingMultipleCards$ | async) &&
    !(hasPendingDrawOffer$ | async) &&
    !(possibleInitialPlaceCardAttempts.length === 0 && isPlayersTurn)
  ) {
    <game-opponent-hand
      [cardSize]="(cardSize$ | async)!"
      [numCards]="(latestGameViewSnapshot$ | async)!.NumCardsInOpponentsHand"
    ></game-opponent-hand>
  }
  @if (isPlacingMultipleCards$ | async) {
    <div
      class="buttons-container rounded-md bg-gray-200 flex justify-between overflow-hidden shadow-md"
    >
      <div
        class="button-question text-gray-800"
        [ngStyle]="{
          'min-width': (cardSize$ | async)! + 'px'
        }"
      >
        <span class="text-left">Place<br />Cards?</span>
      </div>

      <div style="display: flex">
        <app-icon-button
          data-testid="place-cards-button"
          [itemHeight]="(cardSize$ | async)!"
          [itemWidth]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Confirm"
          matTooltipPosition="below"
          materialSymbol="check"
          (selected)="confirmPlaceMultipleCards()"
        ></app-icon-button>
        <app-icon-button
          data-testid="cancel-place-cards-button"
          [itemHeight]="(cardSize$ | async)!"
          [itemWidth]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Cancel"
          matTooltipPosition="below"
          materialSymbol="close"
          (selected)="cancelPlaceMultipleCards()"
        ></app-icon-button>
      </div>
    </div>
  }
  @if (!(isPlacingMultipleCards$ | async) && (hasPendingDrawOffer$ | async)) {
    <div
      class="buttons-container rounded-md bg-gray-200 flex justify-between overflow-hidden shadow-md"
    >
      <div
        class="button-question text-gray-800"
        [ngStyle]="{
          'min-width': (cardSize$ | async)! + 'px'
        }"
      >
        <span class="text-left">Accept<br />Draw?</span>
      </div>

      <div style="display: flex">
        <app-icon-button
          [itemWidth]="(cardSize$ | async)!"
          [itemHeight]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Accept draw"
          matTooltipPosition="below"
          materialSymbol="check"
          (selected)="acceptDraw()"
        ></app-icon-button>
        <app-icon-button
          [itemHeight]="(cardSize$ | async)!"
          [itemWidth]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Deny draw"
          matTooltipPosition="below"
          materialSymbol="close"
          (selected)="denyDraw()"
        ></app-icon-button>
      </div>
    </div>
  }
  @if (
    possibleInitialPlaceCardAttempts.length === 0 &&
    isPlayersTurn &&
    !(isPlacingMultipleCards$ | async) &&
    !(hasPendingDrawOffer$ | async)
  ) {
    <div
      class="buttons-container rounded-md bg-gray-200 flex justify-between overflow-hidden shadow-md"
    >
      <div
        class="button-question text-gray-800"
        [ngStyle]="{
          'min-width': (cardSize$ | async)! + 'px'
        }"
      >
        <span class="text-left"
          >You have no available moves.<br />Would you like to pass?</span
        >
      </div>

      <div style="display: flex">
        <app-icon-button
          [itemWidth]="(cardSize$ | async)!"
          [itemHeight]="(cardSize$ | async)!"
          [iconSize]="(cardSize$ | async)! / 2"
          iconColor="#33312e"
          matTooltip="Pass"
          matTooltipPosition="below"
          materialSymbol="check"
          (selected)="passMove()"
        ></app-icon-button>
      </div>
    </div>
  }
</ng-template>

<ng-template #cardMovementTemplate let-animatedEntity>
  @if (animatedEntity.context.Card) {
    @if (playerGameViewToAnimate$ | async; as playerGameViewToAnimate) {
      <game-card [card]="animatedEntity.context.Card"></game-card>
    }
  } @else {
    <game-face-down-card></game-face-down-card>
  }
</ng-template>
