<div class="game-container">
  <div
    class="game"
    *ngIf="playerGameState$ | async as playerGameState"
    cdkDropListGroup
  >
    <div class="opponent-hand">
      <app-face-down-card
        *ngFor="
          let _ of [].constructor(playerGameState.NumCardsInOpponentsHand)
        "
      ></app-face-down-card>
    </div>

    <!-- Host Board View -->

    <div class="board" *ngIf="playerGameState.IsHost">
      <div class="gutter"></div>

      <ng-container
        *ngFor="let lane of playerGameState.Lanes; let laneIndex = index"
      >
        <ng-container
          *ngIf="(placingMultipleCardsLaneIndex$ | async) != laneIndex"
        >
          <div class="lane">
            <ng-container *ngFor="let row of lane.Rows; let rowIndex = index">
              <app-position
                [laneIndex]="laneIndex"
                [rowIndex]="6 - rowIndex"
                (placeCardAttempted)="attemptMove($event)"
              >
                <app-card
                  *ngIf="lane.Rows[6 - rowIndex].length > 0"
                  [suit]="getTopCard(lane.Rows[6 - rowIndex]).Suit"
                  [kind]="getTopCard(lane.Rows[6 - rowIndex]).Kind"
                  [cardImageFileName]="
                    getCardImageFileName(getTopCard(lane.Rows[6 - rowIndex]))
                  "
                  [isMiddleCard]="rowIndex === 3"
                  [isPlayedBy]="getTopCard(lane.Rows[6 - rowIndex]).PlayedBy"
                  [isHost]="true"
                ></app-card>

                <app-card
                  *ngIf="
                    lane.Rows[6 - rowIndex].length <= 0 &&
                    lane.WonBy != PlayerOrNone.None &&
                    rowIndex === 3
                  "
                  [cardImageFileName]="getJokerImageFileName(laneIndex)"
                  [isMiddleCard]="rowIndex === 3"
                  [isPlayedBy]="lane.WonBy"
                  [isHost]="false"
                ></app-card>
              </app-position>
            </ng-container>
          </div>
        </ng-container>

        <ng-container
          *ngIf="(placingMultipleCardsLaneIndex$ | async) === laneIndex"
        >
          Show special lane
        </ng-container>
      </ng-container>

      <div class="gutter">
        <app-deck
          [totalNumCards]="playerGameState.NumCardsInOpponentsDeck"
          [rightSide]="true"
        ></app-deck>

        <app-deck
          [totalNumCards]="playerGameState.NumCardsInPlayersDeck"
          [rightSide]="true"
        ></app-deck>
      </div>
    </div>

    <!-- Guest Board View -->

    <div class="board" *ngIf="!playerGameState.IsHost">
      <div class="gutter">
        <app-deck
          [totalNumCards]="playerGameState.NumCardsInOpponentsDeck"
          [rightSide]="false"
        ></app-deck>

        <app-deck
          [totalNumCards]="playerGameState.NumCardsInPlayersDeck"
          [rightSide]="false"
        ></app-deck>
      </div>

      <ng-container
        *ngFor="let lane of playerGameState.Lanes; let laneIndex = index"
      >
        <ng-container
          *ngIf="(placingMultipleCardsLaneIndex$ | async) != 4 - laneIndex"
        >
          <div class="lane">
            <ng-container
              *ngFor="
                let row of playerGameState.Lanes[4 - laneIndex].Rows;
                let rowIndex = index
              "
            >
              <app-position
                [laneIndex]="4 - laneIndex"
                [rowIndex]="rowIndex"
                (placeCardAttempted)="attemptMove($event)"
              >
                <app-card
                  *ngIf="row.length > 0"
                  [suit]="getTopCard(row).Suit"
                  [kind]="getTopCard(row).Kind"
                  [cardImageFileName]="getCardImageFileName(getTopCard(row))"
                  [isMiddleCard]="rowIndex === 3"
                  [isPlayedBy]="getTopCard(row).PlayedBy"
                  [isHost]="false"
                ></app-card>

                <app-card
                  *ngIf="
                    row.length <= 0 &&
                    playerGameState.Lanes[4 - laneIndex].WonBy !=
                      PlayerOrNone.None &&
                    rowIndex === 3
                  "
                  [cardImageFileName]="getJokerImageFileName(4 - laneIndex)"
                  [isMiddleCard]="rowIndex === 3"
                  [isPlayedBy]="playerGameState.Lanes[4 - laneIndex].WonBy"
                  [isHost]="false"
                ></app-card>
              </app-position>
            </ng-container>
          </div>
        </ng-container>

        <ng-container
          *ngIf="(placingMultipleCardsLaneIndex$ | async) === 4 - laneIndex"
        >
          Show special lane
        </ng-container>
      </ng-container>

      <div class="gutter"></div>
    </div>

    <div
      class="player-hand"
      id="player-hand"
      cdkDropList
      cdkDropListConnectedTo="position"
      (cdkDropListDropped)="rearrangeHand($event)"
      cdkDropListData="player-hand"
      cdkDropListOrientation="horizontal"
      *ngIf="playerGameState.Hand"
    >
      <app-card
        *ngFor="let card of playerGameState.Hand.Cards"
        [suit]="card.Suit"
        [kind]="card.Kind"
        [cardImageFileName]="getCardImageFileName(card)"
        [playerCanDrag]="true"
      ></app-card>
    </div>

    <div class="button-toolbar">
      <ng-container *ngIf="(placingMultipleCardsLaneIndex$ | async) != null">
        <button mat-raised-button class="confirm-button" color="primary">
          Confirm
        </button>
        <div class="button-divider"></div>
        <button
          mat-raised-button
          class="cancel-button"
          color="warn"
          (click)="cancelPlacingMultipleCards()"
        >
          Cancel
        </button>
      </ng-container>

      <ng-container *ngIf="(placingMultipleCardsLaneIndex$ | async) === null">
        <button
          (click)="passMove()"
          mat-raised-button
          color="primary"
          class="pass-button"
          [disabled]="!isPlayersTurn"
        >
          Pass
        </button>
      </ng-container>
    </div>
  </div>
</div>
