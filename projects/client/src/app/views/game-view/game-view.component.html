<div class="game-container">
  <div
    class="game"
    *ngIf="playerGameState$ | async as playerGameState"
    cdkDropListGroup
  >
    <div
      class="opponent-hand"
      [ngStyle]="{
        height: cardSize + 'px',
        padding: '0px ' + cardSize / 2 + 'px',
        'margin-top': '-' + cardSize / 2 + 'px'
      }"
    >
      <app-face-down-card
        *ngFor="
          let _ of [].constructor(playerGameState.NumCardsInOpponentsHand)
        "
      ></app-face-down-card>
    </div>

    <div
      class="board"
      [ngStyle]="{
        padding: cardSize / 2 + 'px 0px',
        'flex-direction': playerGameState.IsHost ? 'row-reverse' : 'row'
      }"
    >
      <div
        class="gutter"
        [ngStyle]="{
          width: cardSize / 2 + 'px'
        }"
      >
        <app-deck
          [totalNumCards]="playerGameState.NumCardsInOpponentsDeck"
          [rightSide]="playerGameState.IsHost"
        ></app-deck>

        <div class="deck-divider-middle"></div>

        <app-deck
          [totalNumCards]="playerGameState.NumCardsInPlayersDeck"
          [rightSide]="playerGameState.IsHost"
        ></app-deck>

        <div class="deck-divider-end"></div>
      </div>

      <ng-container
        *ngFor="
          let lane of playerGameState.IsHost
            ? playerGameState.Lanes
            : playerGameState.Lanes.slice().reverse();
          let laneIndex = index
        "
      >
        <div
          *ngIf="
            (initialPlaceMultipleCardAttempt$ | async)?.TargetLaneIndex !=
            laneIndex
          "
          class="lane"
          [ngStyle]="{
            'background-color':
              getLaneBackgroundColor(laneIndex) ?? 'transparent'
          }"
        >
          <ng-container
            *ngFor="
              let row of playerGameState.IsHost
                ? playerGameState.Lanes[laneIndex].Rows
                : playerGameState.Lanes[laneIndex].Rows.slice().reverse();
              let rowIndex = index
            "
          >
            <app-position
              [laneIndex]="laneIndex"
              [rowIndex]="playerGameState.IsHost ? rowIndex : 6 - rowIndex"
              (placeCardAttempted)="onPlaceCardAttempted($event)"
            >
              <app-card
                *ngIf="row.length > 0"
                [backgroundColor]="
                  getCardBackgroundColor(getTopCard(row), laneIndex)
                "
                [card]="getTopCard(row)"
                [cardImageFileName]="getCardImageFileName(getTopCard(row))"
                [isMiddleCard]="rowIndex === 3"
                [isPlayedBy]="getTopCard(row).PlayedBy"
                [isHost]="false"
              ></app-card>

              <app-card
                *ngIf="
                  row.length <= 0 &&
                  playerGameState.Lanes[laneIndex].WonBy != PlayerOrNone.None &&
                  rowIndex === 3
                "
                [cardImageFileName]="
                  getJokerImageFileName(
                    laneIndex,
                    playerGameState.RedJokerLaneIndex,
                    playerGameState.BlackJokerLaneIndex
                  )
                "
                [isMiddleCard]="rowIndex === 3"
                [isPlayedBy]="playerGameState.Lanes[laneIndex].WonBy"
                [isHost]="false"
              ></app-card>
            </app-position>
          </ng-container>
        </div>

        <app-place-multiple-cards-lane
          *ngIf="
            (initialPlaceMultipleCardAttempt$ | async)?.TargetLaneIndex ===
            laneIndex
          "
        ></app-place-multiple-cards-lane>
      </ng-container>

      <div
        class="gutter"
        [ngStyle]="{
          width: cardSize / 2 + 'px'
        }"
      ></div>
    </div>

    <div
      class="player-hand"
      id="player-hand"
      cdkDropList
      [cdkDropListConnectedTo]="
        isPlacingMultipleCards ? 'place-multiple-cards-list' : 'position'
      "
      (cdkDropListDropped)="onPlayerHandCardDrop($event)"
      cdkDropListData="player-hand"
      cdkDropListOrientation="horizontal"
      *ngIf="playerGameState.Hand"
      [ngStyle]="{
        height: cardSize + 'px',
        width: 5 * cardSize + 'px',
        margin: 'auto'
      }"
    >
      <app-card
        *ngFor="
          let card of isPlacingMultipleCards
            ? (placeMultipleCardsHand$ | async) ?? []
            : playerGameState.Hand.Cards
        "
        [cardImageFileName]="getCardImageFileName(card)"
        [card]="card"
        [playerCanDrag]="isPlayersTurn"
        [ngStyle]="{
          opacity: isPlayersTurn ? 1 : 0.75
        }"
      ></app-card>
    </div>

    <div
      class="button-toolbar"
      [ngStyle]="{
        padding: '0px ' + cardSize / 2 + 'px'
      }"
    >
      <ng-container *ngIf="isPlacingMultipleCards">
        <button
          mat-raised-button
          class="confirm-button"
          color="primary"
          (click)="onConfirmButtonClicked()"
        >
          Confirm
        </button>
        <div class="button-divider"></div>
        <button
          mat-raised-button
          class="cancel-button"
          color="warn"
          (click)="onCancelButtonClicked()"
        >
          Cancel
        </button>
      </ng-container>

      <ng-container *ngIf="!isPlacingMultipleCards">
        <button
          (click)="onPassButtonClicked()"
          mat-raised-button
          color="primary"
          class="pass-button"
          [disabled]="!isPlayersTurn"
        >
          Pass
        </button>
      </ng-container>
    </div>
  </div>
</div>
